!function(I){var n={};function g(C){if(n[C])return n[C].exports;var t=n[C]={i:C,l:!1,exports:{}};return I[C].call(t.exports,t,t.exports,g),t.l=!0,t.exports}g.m=I,g.c=n,g.d=function(I,n,C){g.o(I,n)||Object.defineProperty(I,n,{enumerable:!0,get:C})},g.r=function(I){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(I,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(I,"__esModule",{value:!0})},g.t=function(I,n){if(1&n&&(I=g(I)),8&n)return I;if(4&n&&"object"==typeof I&&I&&I.__esModule)return I;var C=Object.create(null);if(g.r(C),Object.defineProperty(C,"default",{enumerable:!0,value:I}),2&n&&"string"!=typeof I)for(var t in I)g.d(C,t,function(n){return I[n]}.bind(null,t));return C},g.n=function(I){var n=I&&I.__esModule?function(){return I.default}:function(){return I};return g.d(n,"a",n),n},g.o=function(I,n){return Object.prototype.hasOwnProperty.call(I,n)},g.p="",g(g.s=5)}([function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"a\", function() { return freeform; });\n/**\n * @function freeform\n * @desc Basic handling of text annotations\n */\nfunction freeform(annotation, path, username) {\n    let td; // the object that will go into the table\n    let obj; // the object that will go into the database\n\n    // configure table row\n    td = \"<td contentEditable=true class='noEmpty'></td>\";\n\n    // configure database object\n    obj = {\n        typeOfBinding:2,\n        path: path,\n        format: function(e, d) {\n            if(typeof d.data === 'undefined') {\n                e.get(0).innerHTML = \"\";\n            } else {\n                e.get(0).innerHTML = '<span>'+d.data+'</span>';\n            }\n        },\n        parse: function(e, d) {\n            const obj = d;\n            obj.modified = (new Date()).toJSON();\n            obj.modifiedBy = username;\n            obj.data = e.get(0).textContent;\n            return obj;\n        }\n    };\n\n    return {td, obj};\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi92aWV3L2JyYWluYm94L3NyYy90b29scy9mcmVlZm9ybS5qcz81MzgzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDZTtBQUNmLFdBQVc7QUFDWCxZQUFZOztBQUVaO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLFlBQVk7QUFDWiIsImZpbGUiOiIwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZnVuY3Rpb24gZnJlZWZvcm1cbiAqIEBkZXNjIEJhc2ljIGhhbmRsaW5nIG9mIHRleHQgYW5ub3RhdGlvbnNcbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZnJlZWZvcm0oYW5ub3RhdGlvbiwgcGF0aCwgdXNlcm5hbWUpIHtcbiAgICBsZXQgdGQ7IC8vIHRoZSBvYmplY3QgdGhhdCB3aWxsIGdvIGludG8gdGhlIHRhYmxlXG4gICAgbGV0IG9iajsgLy8gdGhlIG9iamVjdCB0aGF0IHdpbGwgZ28gaW50byB0aGUgZGF0YWJhc2VcblxuICAgIC8vIGNvbmZpZ3VyZSB0YWJsZSByb3dcbiAgICB0ZCA9IFwiPHRkIGNvbnRlbnRFZGl0YWJsZT10cnVlIGNsYXNzPSdub0VtcHR5Jz48L3RkPlwiO1xuXG4gICAgLy8gY29uZmlndXJlIGRhdGFiYXNlIG9iamVjdFxuICAgIG9iaiA9IHtcbiAgICAgICAgdHlwZU9mQmluZGluZzoyLFxuICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICBmb3JtYXQ6IGZ1bmN0aW9uKGUsIGQpIHtcbiAgICAgICAgICAgIGlmKHR5cGVvZiBkLmRhdGEgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgZS5nZXQoMCkuaW5uZXJIVE1MID0gXCJcIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZS5nZXQoMCkuaW5uZXJIVE1MID0gJzxzcGFuPicrZC5kYXRhKyc8L3NwYW4+JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKGUsIGQpIHtcbiAgICAgICAgICAgIGNvbnN0IG9iaiA9IGQ7XG4gICAgICAgICAgICBvYmoubW9kaWZpZWQgPSAobmV3IERhdGUoKSkudG9KU09OKCk7XG4gICAgICAgICAgICBvYmoubW9kaWZpZWRCeSA9IHVzZXJuYW1lO1xuICAgICAgICAgICAgb2JqLmRhdGEgPSBlLmdldCgwKS50ZXh0Q29udGVudDtcbiAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcmV0dXJuIHt0ZCwgb2JqfTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///0\n")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"a\", function() { return hidden; });\n/**\n * @function hidden\n * @desc Handles hidden text annotations\n */\nfunction hidden(annotation, path, username) {\n    let td; // the object that will go into the table\n    let obj; // the object that will go into the database\n\n    // configure table row\n    td = \"<td contentEditable=true class='hidden'></td>\";\n\n    // configure database object\n    obj = {\n        typeOfBinding:2,\n        path: path,\n        format: function(e, d) {\n            if(typeof d.data === 'undefined') {\n                e.get(0).innerHTML = \"\";\n            } else {\n                e.get(0).innerHTML = '<span>'+d.data+'</span>';\n            }\n        },\n        parse: function(e, d) {\n            const obj = d;\n            obj.modified = (new Date()).toJSON();\n            obj.modifiedBy = username;\n            obj.data = e.get(0).textContent;\n            return obj;\n        }\n    };\n\n    return {td, obj};\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi92aWV3L2JyYWluYm94L3NyYy90b29scy9oaWRkZW4uanM/NzVmOCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ2U7QUFDZixXQUFXO0FBQ1gsWUFBWTs7QUFFWjtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxZQUFZO0FBQ1oiLCJmaWxlIjoiMS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZ1bmN0aW9uIGhpZGRlblxuICogQGRlc2MgSGFuZGxlcyBoaWRkZW4gdGV4dCBhbm5vdGF0aW9uc1xuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBoaWRkZW4oYW5ub3RhdGlvbiwgcGF0aCwgdXNlcm5hbWUpIHtcbiAgICBsZXQgdGQ7IC8vIHRoZSBvYmplY3QgdGhhdCB3aWxsIGdvIGludG8gdGhlIHRhYmxlXG4gICAgbGV0IG9iajsgLy8gdGhlIG9iamVjdCB0aGF0IHdpbGwgZ28gaW50byB0aGUgZGF0YWJhc2VcblxuICAgIC8vIGNvbmZpZ3VyZSB0YWJsZSByb3dcbiAgICB0ZCA9IFwiPHRkIGNvbnRlbnRFZGl0YWJsZT10cnVlIGNsYXNzPSdoaWRkZW4nPjwvdGQ+XCI7XG5cbiAgICAvLyBjb25maWd1cmUgZGF0YWJhc2Ugb2JqZWN0XG4gICAgb2JqID0ge1xuICAgICAgICB0eXBlT2ZCaW5kaW5nOjIsXG4gICAgICAgIHBhdGg6IHBhdGgsXG4gICAgICAgIGZvcm1hdDogZnVuY3Rpb24oZSwgZCkge1xuICAgICAgICAgICAgaWYodHlwZW9mIGQuZGF0YSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBlLmdldCgwKS5pbm5lckhUTUwgPSBcIlwiO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBlLmdldCgwKS5pbm5lckhUTUwgPSAnPHNwYW4+JytkLmRhdGErJzwvc3Bhbj4nO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBwYXJzZTogZnVuY3Rpb24oZSwgZCkge1xuICAgICAgICAgICAgY29uc3Qgb2JqID0gZDtcbiAgICAgICAgICAgIG9iai5tb2RpZmllZCA9IChuZXcgRGF0ZSgpKS50b0pTT04oKTtcbiAgICAgICAgICAgIG9iai5tb2RpZmllZEJ5ID0gdXNlcm5hbWU7XG4gICAgICAgICAgICBvYmouZGF0YSA9IGUuZ2V0KDApLnRleHRDb250ZW50O1xuICAgICAgICAgICAgcmV0dXJuIG9iajtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICByZXR1cm4ge3RkLCBvYmp9O1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///1\n")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "a", function() { return multiple; });\n/**\n * @function multiple\n * @desc Handles annotations restricted to a reduced number of options\n */\n\nfunction multiple(annotation, path, username) {\n    let td = []; // the object that will go into the table\n    let obj; // the object that will go into the database\n    const values = annotation.values.split(/[, ]+/);\n\n    // configure table row\n    td.push("<td><select value=0><option value=\'\' disabled selected hidden>Empty</option>");\n    for (var o in values) {\n        td.push("<option value=\\"" + values[o] + "\\"" + ">" + values[o] + "</option>");\n    }\n    td.push("</select></td>");\n    td = td.join("\\n");\n\n    // configure database object\n    obj = {\n        typeOfBinding:2,\n        path: path,\n        format: function(e, d) {\n            var obj = d;\n            if (typeof obj.data !== \'undefined\') {\n                /**\n                 * @todo Replace color assignment by the addition of a class\n                 */\n                e.get(0).querySelectorAll("select")[0].style.color = "#fff"; \n                e.get(0).querySelectorAll("select")[0].value = obj.data; \n            } else {\n                e.get(0).querySelectorAll("select")[0].value = ""; \n            }\n        },\n        parse: function(e, d) {\n            if (e.get(0).querySelectorAll("select")[0].value) {\n                e.get(0).querySelectorAll("select")[0].style.color = "#fff";\n            }\n            const obj = d;\n            obj.modified = (new Date()).toJSON();\n            obj.modifiedBy = username;\n            obj.data = e.get(0).querySelectorAll("select")[0].value;\n            return obj;\n        }\n    };\n\n    return {td, obj};\n}\n\n\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi92aWV3L2JyYWluYm94L3NyYy90b29scy9tdWx0aXBsZS5qcz9hYWUwIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUE7QUFDQTtBQUNBO0FBQ0E7O0FBRWU7QUFDZixnQkFBZ0I7QUFDaEIsWUFBWTtBQUNaOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNEU7QUFDQSx3RTtBQUNBLGFBQWE7QUFDYixrRTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsWUFBWTtBQUNaIiwiZmlsZSI6IjIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmdW5jdGlvbiBtdWx0aXBsZVxuICogQGRlc2MgSGFuZGxlcyBhbm5vdGF0aW9ucyByZXN0cmljdGVkIHRvIGEgcmVkdWNlZCBudW1iZXIgb2Ygb3B0aW9uc1xuICovXG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIG11bHRpcGxlKGFubm90YXRpb24sIHBhdGgsIHVzZXJuYW1lKSB7XG4gICAgbGV0IHRkID0gW107IC8vIHRoZSBvYmplY3QgdGhhdCB3aWxsIGdvIGludG8gdGhlIHRhYmxlXG4gICAgbGV0IG9iajsgLy8gdGhlIG9iamVjdCB0aGF0IHdpbGwgZ28gaW50byB0aGUgZGF0YWJhc2VcbiAgICBjb25zdCB2YWx1ZXMgPSBhbm5vdGF0aW9uLnZhbHVlcy5zcGxpdCgvWywgXSsvKTtcblxuICAgIC8vIGNvbmZpZ3VyZSB0YWJsZSByb3dcbiAgICB0ZC5wdXNoKFwiPHRkPjxzZWxlY3QgdmFsdWU9MD48b3B0aW9uIHZhbHVlPScnIGRpc2FibGVkIHNlbGVjdGVkIGhpZGRlbj5FbXB0eTwvb3B0aW9uPlwiKTtcbiAgICBmb3IgKHZhciBvIGluIHZhbHVlcykge1xuICAgICAgICB0ZC5wdXNoKFwiPG9wdGlvbiB2YWx1ZT1cXFwiXCIgKyB2YWx1ZXNbb10gKyBcIlxcXCJcIiArIFwiPlwiICsgdmFsdWVzW29dICsgXCI8L29wdGlvbj5cIik7XG4gICAgfVxuICAgIHRkLnB1c2goXCI8L3NlbGVjdD48L3RkPlwiKTtcbiAgICB0ZCA9IHRkLmpvaW4oXCJcXG5cIik7XG5cbiAgICAvLyBjb25maWd1cmUgZGF0YWJhc2Ugb2JqZWN0XG4gICAgb2JqID0ge1xuICAgICAgICB0eXBlT2ZCaW5kaW5nOjIsXG4gICAgICAgIHBhdGg6IHBhdGgsXG4gICAgICAgIGZvcm1hdDogZnVuY3Rpb24oZSwgZCkge1xuICAgICAgICAgICAgdmFyIG9iaiA9IGQ7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9iai5kYXRhICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIEB0b2RvIFJlcGxhY2UgY29sb3IgYXNzaWdubWVudCBieSB0aGUgYWRkaXRpb24gb2YgYSBjbGFzc1xuICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIGUuZ2V0KDApLnF1ZXJ5U2VsZWN0b3JBbGwoXCJzZWxlY3RcIilbMF0uc3R5bGUuY29sb3IgPSBcIiNmZmZcIjsgXG4gICAgICAgICAgICAgICAgZS5nZXQoMCkucXVlcnlTZWxlY3RvckFsbChcInNlbGVjdFwiKVswXS52YWx1ZSA9IG9iai5kYXRhOyBcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZS5nZXQoMCkucXVlcnlTZWxlY3RvckFsbChcInNlbGVjdFwiKVswXS52YWx1ZSA9IFwiXCI7IFxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBwYXJzZTogZnVuY3Rpb24oZSwgZCkge1xuICAgICAgICAgICAgaWYgKGUuZ2V0KDApLnF1ZXJ5U2VsZWN0b3JBbGwoXCJzZWxlY3RcIilbMF0udmFsdWUpIHtcbiAgICAgICAgICAgICAgICBlLmdldCgwKS5xdWVyeVNlbGVjdG9yQWxsKFwic2VsZWN0XCIpWzBdLnN0eWxlLmNvbG9yID0gXCIjZmZmXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBvYmogPSBkO1xuICAgICAgICAgICAgb2JqLm1vZGlmaWVkID0gKG5ldyBEYXRlKCkpLnRvSlNPTigpO1xuICAgICAgICAgICAgb2JqLm1vZGlmaWVkQnkgPSB1c2VybmFtZTtcbiAgICAgICAgICAgIG9iai5kYXRhID0gZS5nZXQoMCkucXVlcnlTZWxlY3RvckFsbChcInNlbGVjdFwiKVswXS52YWx1ZTtcbiAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcmV0dXJuIHt0ZCwgb2JqfTtcbn1cblxuXG4iXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///2\n')},,,function(module,__webpack_exports__,__webpack_require__){"use strict";eval('__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _tools_freeform_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(0);\n/* harmony import */ var _tools_hidden_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(1);\n/* harmony import */ var _tools_multiple_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(2);\n\n\n\n\nvar mriInfoOrig;\nvar textAnnotationsArray = [];\nvar version=1;\nvar volAnnParam, textAnnParam;\n\n// Prevent zoom on double tap\n$(\'body\').on(\'touchstart\', function preventZoom(e) {\n    var t2 = e.timeStamp,\n        t1 = $(this).data(\'lastTouch\') || t2,\n        dt = t2 - t1,\n        fingers = e.originalEvent.touches.length;\n    $(this).data(\'lastTouch\', t2);\n    if (!dt || dt > 500 || fingers > 1) return; // not double-tap\n    e.preventDefault(); // double tap - prevent the zoom\n    // also synthesize click events we just swallowed up\n    $(this).trigger(\'click\').trigger(\'click\');\n});\n\nif( $.isEmptyObject(mriInfo)) {\n    $("#stereotaxic").prepend("<h2>ERROR: Cannot read the data.</h2><p>The file is maybe corrupt?</p>");\n    console.log("ERROR: Cannot read data. The file is maybe corrupt?");\n\n    $("#annotationsPane").hide();\n    $("#data").show();\n\n} else {\n    params.info=mriInfo;\n\n    var fullscreen=false;\n    if(params.fullscreen)\n        params.fullscreen=(params.fullscreen=="true");\n\n    $("#loadingIndicator").show();\n\n    // Load data\n    BrainBox.initBrainBox()\n    .then(function () { console.log("BrainBox initialised"); return BrainBox.loadLabelsets(); })\n    .then(function () { console.log("Label sets loaded"); return BrainBox.configureBrainBox(params); })\n    .then(function () {\n        console.log("BrainBox configured");\n        // backup the original MRI info\n        mriInfoOrig = JSON.parse(JSON.stringify(BrainBox.info));\n         \n        // Serialise text annotations object (text annotations are stored as objects in the\n        // database, but used as an array here)\n        if(mriInfo.mri && mriInfo.mri.annotations) {\n            textAnnotationsArray = BrainBox.annotationsObjectToArray(mriInfo.mri.annotations);\n        }\n\n    // Bind general information\n    //--------------------------\n        bind2(info_proxy,BrainBox.info,"name",$("#name"));\n        bind1(info_proxy,BrainBox.info,"source",$("#source"));\n        bind1(info_proxy,BrainBox.info,"included",$("#included"),date_format);\n\n\n    // Bind volume-type annotations\n    //------------------------------\n        volAnnParam = {\n            table: $("table#annotations"),\n            info_proxy: info_proxy,\n            info: BrainBox.info,\n            trTemplate: $.map([\n                "<tr>",\n                " <td contentEditable=true class=\'noEmpty\'></td>", // name\n                " <td><select>",$.map(BrainBox.labelSets,function(o){return "<option>"+o.name+"</option>"}),"</select></td>",\t// value\n                " <td class=\'noEmpty\'></td>", // project\n                " <td></td>", // modified\n                " <td>", // access\n                "  <div class=\'access\'>",\n                "   <span class=\'view\' title=\'view annotations\'></span>",\n                "   <span class=\'edit\' title=\'edit annotations\'></span>",\n                "   <span class=\'add\' title=\'add annotations\'></span>",\n                "   <span class=\'remove\' title=\'remove annotations\'></span>",\n                "  </div>",\n                " </td>",\n                "</tr>"],function(o){return o}).join(""),\n            objTemplate: [\n                {   typeOfBinding:2,\n                    path:"mri.atlas.#.name" // name\n                },\n                {   typeOfBinding:2,\n                    path:"mri.atlas.#.labels", //value\n                    format: function(e,d){$(e).find("select").prop(\'selectedIndex\',$.map(BrainBox.labelSets,function(o){return o.source}).indexOf(d))},\n                    parse: function(e){var name=$(e).find("select").val(),i=$.map(BrainBox.labelSets,function(o){return o.name}).indexOf(name);return BrainBox.labelSets[i].source}\n                },\n                {   typeOfBinding:1, // project\n                    path:"mri.atlas.#.project",\n                    format: function(e,d){$(e).html(\'<a href="/project/\'+d+\'">\'+d+\'</a>\')}\n                },\n                {   typeOfBinding:1,\n                    path:"mri.atlas.#.modified",\n                    format: date_format\n                },\n                {   typeOfBinding:1,\n                    path:"mri.atlas.#.access",\n                    format: function(e,d){$(e).find(".access").attr(\'data-level\',["none","view","edit","add","remove"].indexOf(d))},\n                    parse: function(e){var level=$(e).find(".access").attr("data-level");return ["none","view","edit","add","remove"][level]}\n                }\n            ]\n        };\n        for(var i=0;i<BrainBox.info.mri.atlas.length;i++) {\n            BrainBox.appendAnnotationTableRow(i,volAnnParam);\n        }\n        // connect pop-down menus\n        $(document).on(\'change\', "table#annotations select", function(){\n            var col=$("table#annotations tr:eq(0) th:eq("+$(this).closest(\'td\')[0].cellIndex+")").text();\n            var index=$(this).closest(\'tr\')[0].rowIndex-1;\n            switch(col) {\n                case "Value":\n                    var url="/labels/" + info_proxy["mri.atlas."+index+".labels"];\n                    $.getJSON(url,function(json) {\n                        AtlasMakerWidget.configureOntology(json);\n                        AtlasMakerWidget.changePenColor(0);\n                        AtlasMakerWidget.brain_img.img=null; // to force redraw with new colors\n                        AtlasMakerWidget.drawImages();\n                        $("#loadingIndicator").hide();\n                    });\n                    break;\n            }\n        });\n        // volume annotation table: select row\n        $(document).on(\'click touchstart\', "#annotations tr",function(){BrainBox.selectAnnotationTableRow($(this).index(),volAnnParam)});\n        // volume annotations table: add, remove and save annotations\n        $(document).on(\'click touchstart\', "#addAnnotation", function(){addAnnotation(volAnnParam)});\n        $(document).on(\'click touchstart\', "#removeAnnotation", function(){removeAnnotation(volAnnParam)});\n        // volume annotations table: select the first row by default\n        $("table#annotations tr").removeClass("selected");\n        $("table#annotations tr").eq(1).addClass("selected");\n\n    // Bind text annotations\n    //-----------------------\n        var trTemplate;\n        var objTemplate;\n        var i, j, p, n;\n\n        trTemplate = [\n            "<tr>",\n            " <td contentEditable=true class=\'noEmpty\'></td>", // name\n            " <td contentEditable=true class=\'noEmpty\'></td>", // value\n            " <td class=\'noEmpty\'></td>", // project\n            " <td></td>", // modified\n            " <td>", // access\n            "  <div class=\'access\'>",\n            "   <span class=\'view\' title=\'view annotations\'></span>",\n            "   <span class=\'edit\' title=\'edit annotations\'></span>",\n            "   <span class=\'add\' title=\'add annotations\'></span>",\n            "   <span class=\'remove\' title=\'remove annotations\'></span>",\n            "  </div>",\n            " </td>",\n            "</tr>"\n        ].join("");\n\n        objTemplate = [\n            {   typeOfBinding:2,\n                path:"#.name", // name\n            },\n            {   typeOfBinding:2,\n                path:"#.data" // value\n            },\n            {   typeOfBinding:1,\n                path:"#.project", // project\n                format: function(e,d){$(e).html(\'<a href="/project/\'+d+\'">\'+d+\'</a>\')}\n            },\n            {   typeOfBinding:1,\n                path:"#.modified", // modified\n                format: date_format\n            },\n            {   typeOfBinding:1,\n                path:"#.access",\n                format: function(e,d){$(e).find(".access").attr(\'data-level\',BrainBox.accessLevels.indexOf(d))},\n                parse: function(e){var level=$(e).find(".access").attr("data-level");return BrainBox.accessLevels[level]}\n            }\n        ];\n\n        textAnnParam = {\n            table: $("table#textAnnotations"),\n            info_proxy: info_proxy,\n            info: textAnnotationsArray,\n            trTemplate: trTemplate,\n            objTemplate: objTemplate\n        };\n\n        for(i=0;i<textAnnotationsArray.length;i++) {\n            BrainBox.appendAnnotationTableRow(i,textAnnParam);\n        }\n\n        $(document).on(\'click touchstart\', "#textAnnotations tr",function() {\n            var table=$(this).closest("tbody");\n            $(table).find("tr").removeClass("selected");\n            $(this).addClass("selected");\n        });\n        $(document).on(\'click touchstart\', "#addTextAnnotation", function(){addTextAnnotation(textAnnParam)});\n        $(document).on(\'click touchstart\', "#removeTextAnnotation", function(){removeTextAnnotation(textAnnParam)});\n\n        // text annotations table: select the first row by default\n        $("table#textAnnotations tr").removeClass("selected");\n        $("table#textAnnotations tr").eq(1).addClass("selected");\n        \n        // connect close button in labels set\n        $(document).on(\'click touchstart\', "#labels-close", function(){$("#labelset").hide()});\n\n        $("#data").show();\n\n    // Listen to changes that trigger a metadata save\n    //------------------------------------------------\n        // send data when focus is lost (on blur)\n        $(document).on(\'blur\', "[contenteditable]", function from_project(e) {\n            saveAnnotationsChange(BrainBox.info);\n        });\n        // blur when [enter] is clicked, to trigger data sending\n        $(document).on(\'keydown\', "[contenteditable]", function(e) {\n            if(e.which==13 && $(e.target).attr(\'contenteditable\')) {\n                e.preventDefault();\n                $(e.target).blur();\n            }\n        });\n        // blur when <select> changes value to trigger data sending\n        $("#annotations tbody, #textAnnotations tbody").on(\'change\', "select", function(e) {\n            $(e.target).blur();\n            saveAnnotationsChange(BrainBox.info);\n        });\n\n    // WS Autocompletion\n    //-------------------\n        var cb, label;\n        AtlasMakerWidget.receiveFunctions["similarProjectNamesQuery"] = function(data) {\n            var arr = [];\n            if(label=="similarProjectNames")\n                arr=$.map(data.metadata,function(o){return {label:o.shortname,shortname:o.shortname,name:o.name}});\n            cb(arr);\n        };\n\n        $(".autocomplete").autocomplete({\n            minLength: 0,\n            source: function(req,res) {\n                var key = $(this.element).attr(\'data-autocomplete\');\n                switch(key) {\n                    case "user.similarProjectNames":\n                        AtlasMakerWidget.socket.send(JSON.stringify({"type":"similarProjectNamesQuery", "metadata":{"projectName":req.term}}));\n                        label="similarProjectNames";\n                        break;\n                }\n                cb=res;\n            },\n            select:function(e,ui) {\n                var irow=$(e.target).closest(\'tr\').index();\n                info_proxy["mri.atlas."+irow+".project"]=ui.item.name;\n\n                // add user to access objects\n                // projectInfo.collaborators.list[irow].userID=ui.item.nickname;\n            }\n        });\n\n    })\n    .catch(err => {\n        $("#msgLog").html("ERROR: Can\'t load data. " + err);\n        console.error(err);\n    });\n}\n\n$("#addProject").click(function(){location="/project/new"});\n\n/**\n * @function addAnnotation\n * @desc Add an empty volume annotation\n */\nfunction addAnnotation(param) {\n    var date=new Date();\n    var i, found;\n\n    // check that there is no other empty annotation already created\n    found = false;\n    for(i=0;i<BrainBox.info.mri.atlas.length;i++) {\n        if(BrainBox.info.mri.atlas[i].name === "" && BrainBox.info.mri.atlas[i].project === "") {\n            found = true;\n            break;\n        }\n    }\n    if(found) {\n        $("#annotationMessage").text("An empty annotation already exists");\n        setTimeout(function(){$("#annotationMessage").text("")},2000);\n        return;\n    }\n    \n    // add data to annotations array\n    BrainBox.info.mri.atlas.push({\n        name:"",\n        project:"",\n        access: "edit", \n        created: date.toJSON(), \n        modified: date.toJSON(), \n        filename: Math.random().toString(36).slice(2)+".nii.gz",\t// automatically generated filename\n        labels: "foreground.json",\n        owner: AtlasMakerWidget.User.username,\n        type: "volume"\n    });\n\n    // add and bind new table row\n    var i=BrainBox.info.mri.atlas.length-1;\n    BrainBox.appendAnnotationTableRow(i,param);\n    \n    //select new annotation\n    BrainBox.selectAnnotationTableRow(i,param);\n\n    // update in server\n    saveAnnotationsChange(BrainBox.info);\n}\n\n/**\n * @function removeAnnotation\n */\nfunction removeAnnotation(param) {\n    // find row index\n    var index=$(param.table).find("tbody .selected").index();\n\n    // prevent removal of a last projet-less annotation\n    if(BrainBox.info.mri.atlas[index].project == "") {\n        var nPublicAnnotations = BrainBox.info.mri.atlas.map(function(o){return (o.project=="")}).length;\n        if(nPublicAnnotations == 1) {\n            $("#annotationMessage").text("There has to be at least 1 public volume annotation");\n            setTimeout(function(){$("#annotationMessage").text("")},2000);\n            return;\n        }\n    }\n\n    // remove row from table\n    $(param.table).find(\'tbody tr:eq(\'+index+\')\').remove();\n\n    // select previous row (or 1st one)\n    BrainBox.selectAnnotationTableRow(Math.max(0,index-1),param);\n\n    // remove binding\n    JSON.stringify(param.info_proxy); // update BrainBox.info from info_proxy\n    var irow=BrainBox.info.mri.atlas.length-1;\n    for(var icol=0; icol<param.objTemplate.length; icol++) {\n        unbind2(param.info_proxy,param.objTemplate[icol].path.replace("#", irow));\n    }\n\n    // remove row from BrainBox.info.mri.atlas\n    BrainBox.info.mri.atlas.splice(index,1);\n\n    // update in server\n    saveAnnotationsChange(BrainBox.info);\n}\n/**\n * @function addTextAnnotation\n */\nfunction addTextAnnotation(param) {\n    var date=new Date();\n    var i;\n    \n    // check that there is no other empty annotation already created\n    if(BrainBox.info.mri.annotations[""] && BrainBox.info.mri.annotations[""][""]) {\n        $("#textAnnotationMessage").text("An empty annotation already exists");\n        setTimeout(function(){$("#textAnnotationMessage").text("")},2000);\n        return;\n    }\n\n    // add data to annotations array\n    textAnnotationsArray.push({\n        name:"",\n        project:"",\n        access: "edit", \n        created: date.toJSON(), \n        modified: date.toJSON(), \n        owner: AtlasMakerWidget.User.username,\n        type: "text",\n        data: ""\n    });\n    // add and bind new table row\n    var i=textAnnotationsArray.length-1;\n    BrainBox.appendAnnotationTableRow(i,param);\n\n    //select new annotation\n    selectTextAnnotationTableRow(i,param);\n\n    // save change\n    saveAnnotationsChange(BrainBox.info);\n}\n/**\n * @function removeTextAnnotation\n */\nfunction removeTextAnnotation(param) {\n    var index=$(param.table).find("tbody .selected").index();\n    $(param.table).find(\'tbody tr:eq(\'+index+\')\').remove();\n    // remove binding\n    JSON.stringify(param.info_proxy); // update textAnnotationsArray from info_proxy\n    var irow=textAnnotationsArray.length-1;\n    for(var icol=0; icol<param.objTemplate.length; icol++) {\n        unbind2(param.info_proxy,param.objTemplate[icol].path.replace("#", irow));\n    }\n    // remove row from textAnnotationsArray\n    textAnnotationsArray.splice(index,1);\n\n    // select previous row (or 1st one)\n    selectTextAnnotationTableRow(Math.max(0,index-1),param);\n\n    // save change\n    saveAnnotationsChange(BrainBox.info);\n}\nfunction selectTextAnnotationTableRow(index,param) {\n    var table=param.table;\n    var currentIndex=$(table).find("tr.selected").index();\n\n    if(index>=0 && currentIndex!=index) {\n        $(table).find("tr").removeClass("selected");\n        $(table).find(\'tbody tr:eq(\'+index+\')\').addClass("selected");\n    }\n}\n\n/**\n * @function saveAnnotationsChange\n */\nfunction saveAnnotationsChange(info) {\n    var i, j;\n\n    // update content of projectInfo object from proxy by calling all getters\n    JSON.stringify(info_proxy);\n\n    // check the info object for duplicate volume annotations\n    for(i=0;i<info.mri.atlas.length-1;i++) {\n        for(j=i+1;j<info.mri.atlas.length;j++) {\n            if( info.mri.atlas[i].name === info.mri.atlas[j].name\n                && info.mri.atlas[i].project === info.mri.atlas[j].project) {\n                $("#annotationMessage").text("There is already an annotation with that name and project");\n                setTimeout(function(){$("#annotationMessage").text("")},2000);\n                //$.extend(true, info.mri, mriInfoOrig.mri);\n                resetBindingProxy(volAnnParam, mriInfoOrig);\n                return;\n            }\n        }\n    }\n\n    // check the info object for duplicate text annotations\n    for(i=0;i<textAnnotationsArray.length-1;i++) {\n        for(j=i+1;j<textAnnotationsArray.length;j++) {\n            if( textAnnotationsArray[i].name === textAnnotationsArray[j].name\n                && textAnnotationsArray[i].project === textAnnotationsArray[j].project) {\n                $("#textAnnotationMessage").text("There is already an annotation with that name and project");\n                setTimeout(function(){$("#textAnnotationMessage").text("")},2000);\n                //$.extend(true, textAnnotationsArray, BrainBox.annotationsObjectToArray(mriInfoOrig.mri.annotations));\n                resetBindingProxy(textAnnParam, BrainBox.annotationsObjectToArray(mriInfoOrig.mri.annotations));\n                return;\n            }\n        }\n    }\n        \n    // convert the text annotations array into an object\n    info.mri.annotations = BrainBox.annotationsArrayToObject(textAnnotationsArray);\n    \n    // compute a diff patch between the new and old versions of the info object\n    var patch = jsonpatch.compare(mriInfoOrig, info);\n    if(patch.length == 0) {\n        console.log("Nothing changed");\n        return;\n    }\n    \n    // send the patch to the server and update the stored version\n    AtlasMakerWidget.sendSaveMetadataMessage(info,"patch",patch)\n    .then(function() {\n        mriInfoOrig = JSON.parse(JSON.stringify(info));\n    });\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi92aWV3L2JyYWluYm94L3NyYy9wYWdlcy9tcmktcGFnZS5qcz84MDJhIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQTRDO0FBQ0o7QUFDSTs7QUFFNUM7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQ0FBK0M7QUFDL0MsdUJBQXVCO0FBQ3ZCO0FBQ0E7QUFDQSxDQUFDOztBQUVEO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBLENBQUM7QUFDRDs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBLHVCQUF1QixxQ0FBcUMsaUNBQWlDLEVBQUU7QUFDL0YsdUJBQXVCLGtDQUFrQywyQ0FBMkMsRUFBRTtBQUN0RztBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQUdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFFQUFxRSxxQ0FBcUM7QUFDMUc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUMsU0FBUztBQUM5QztBQUNBLGlCQUFpQjtBQUNqQjtBQUNBLGlCQUFpQjtBQUNqQixpQkFBaUI7QUFDakI7QUFDQSwwQ0FBMEMsOEVBQThFLGdCQUFnQixjQUFjO0FBQ3RKLHVDQUF1QywwRUFBMEUsY0FBYyxnQkFBZ0I7QUFDL0ksaUJBQWlCO0FBQ2pCLGlCQUFpQjtBQUNqQjtBQUNBLDBDQUEwQztBQUMxQyxpQkFBaUI7QUFDakIsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakIsaUJBQWlCO0FBQ2pCO0FBQ0EsMENBQTBDLHlGQUF5RjtBQUNuSSx1Q0FBdUMsa0RBQWtEO0FBQ3pGO0FBQ0E7QUFDQTtBQUNBLG9CQUFvQixpQ0FBaUM7QUFDckQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNERBQTREO0FBQzVEO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBLHdFQUF3RSwrREFBK0Q7QUFDdkk7QUFDQSx3RUFBd0UsMkJBQTJCO0FBQ25HLDJFQUEyRSw4QkFBOEI7QUFDekc7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxhQUFhO0FBQ2I7QUFDQSxhQUFhO0FBQ2IsYUFBYTtBQUNiO0FBQ0EsYUFBYTtBQUNiLGFBQWE7QUFDYjtBQUNBLHNDQUFzQztBQUN0QyxhQUFhO0FBQ2IsYUFBYTtBQUNiO0FBQ0E7QUFDQSxhQUFhO0FBQ2IsYUFBYTtBQUNiO0FBQ0Esc0NBQXNDLHlFQUF5RTtBQUMvRyxtQ0FBbUMsa0RBQWtEO0FBQ3JGO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsZ0JBQWdCLDhCQUE4QjtBQUM5QztBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNULDRFQUE0RSxnQ0FBZ0M7QUFDNUcsK0VBQStFLG1DQUFtQzs7QUFFbEg7QUFDQTtBQUNBOztBQUVBO0FBQ0EsdUVBQXVFLHNCQUFzQjs7QUFFN0Y7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTOztBQUVUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9EQUFvRCxRQUFRLHFEQUFxRDtBQUNqSDtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFFQUFxRSwrQ0FBK0Msd0JBQXdCO0FBQzVJO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxTQUFTOztBQUVULEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7O0FBRUEsa0NBQWtDLHdCQUF3Qjs7QUFFMUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLFlBQVksaUNBQWlDO0FBQzdDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsOEJBQThCLGlDQUFpQztBQUMvRDtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLOztBQUVMO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLHlFQUF5RSx1QkFBdUI7QUFDaEc7QUFDQTtBQUNBLGtDQUFrQyxpQ0FBaUM7QUFDbkU7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBLHFDQUFxQztBQUNyQztBQUNBLG1CQUFtQiwrQkFBK0I7QUFDbEQ7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSw4QkFBOEIscUNBQXFDO0FBQ25FO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUM7QUFDckM7QUFDQSxtQkFBbUIsK0JBQStCO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0EsWUFBWSwwQkFBMEI7QUFDdEMsa0JBQWtCLHdCQUF3QjtBQUMxQztBQUNBO0FBQ0E7QUFDQSxzQ0FBc0MsaUNBQWlDO0FBQ3ZFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBLFlBQVksZ0NBQWdDO0FBQzVDLGtCQUFrQiw4QkFBOEI7QUFDaEQ7QUFDQTtBQUNBO0FBQ0Esc0NBQXNDLHFDQUFxQztBQUMzRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0wiLCJmaWxlIjoiNS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcmVlZm9ybSBmcm9tICcuLi90b29scy9mcmVlZm9ybS5qcyc7XG5pbXBvcnQgaGlkZGVuIGZyb20gJy4uL3Rvb2xzL2hpZGRlbi5qcyc7XG5pbXBvcnQgbXVsdGlwbGUgZnJvbSAnLi4vdG9vbHMvbXVsdGlwbGUuanMnO1xuXG52YXIgbXJpSW5mb09yaWc7XG52YXIgdGV4dEFubm90YXRpb25zQXJyYXkgPSBbXTtcbnZhciB2ZXJzaW9uPTE7XG52YXIgdm9sQW5uUGFyYW0sIHRleHRBbm5QYXJhbTtcblxuLy8gUHJldmVudCB6b29tIG9uIGRvdWJsZSB0YXBcbiQoJ2JvZHknKS5vbigndG91Y2hzdGFydCcsIGZ1bmN0aW9uIHByZXZlbnRab29tKGUpIHtcbiAgICB2YXIgdDIgPSBlLnRpbWVTdGFtcCxcbiAgICAgICAgdDEgPSAkKHRoaXMpLmRhdGEoJ2xhc3RUb3VjaCcpIHx8IHQyLFxuICAgICAgICBkdCA9IHQyIC0gdDEsXG4gICAgICAgIGZpbmdlcnMgPSBlLm9yaWdpbmFsRXZlbnQudG91Y2hlcy5sZW5ndGg7XG4gICAgJCh0aGlzKS5kYXRhKCdsYXN0VG91Y2gnLCB0Mik7XG4gICAgaWYgKCFkdCB8fCBkdCA+IDUwMCB8fCBmaW5nZXJzID4gMSkgcmV0dXJuOyAvLyBub3QgZG91YmxlLXRhcFxuICAgIGUucHJldmVudERlZmF1bHQoKTsgLy8gZG91YmxlIHRhcCAtIHByZXZlbnQgdGhlIHpvb21cbiAgICAvLyBhbHNvIHN5bnRoZXNpemUgY2xpY2sgZXZlbnRzIHdlIGp1c3Qgc3dhbGxvd2VkIHVwXG4gICAgJCh0aGlzKS50cmlnZ2VyKCdjbGljaycpLnRyaWdnZXIoJ2NsaWNrJyk7XG59KTtcblxuaWYoICQuaXNFbXB0eU9iamVjdChtcmlJbmZvKSkge1xuICAgICQoXCIjc3RlcmVvdGF4aWNcIikucHJlcGVuZChcIjxoMj5FUlJPUjogQ2Fubm90IHJlYWQgdGhlIGRhdGEuPC9oMj48cD5UaGUgZmlsZSBpcyBtYXliZSBjb3JydXB0PzwvcD5cIik7XG4gICAgY29uc29sZS5sb2coXCJFUlJPUjogQ2Fubm90IHJlYWQgZGF0YS4gVGhlIGZpbGUgaXMgbWF5YmUgY29ycnVwdD9cIik7XG5cbiAgICAkKFwiI2Fubm90YXRpb25zUGFuZVwiKS5oaWRlKCk7XG4gICAgJChcIiNkYXRhXCIpLnNob3coKTtcblxufSBlbHNlIHtcbiAgICBwYXJhbXMuaW5mbz1tcmlJbmZvO1xuXG4gICAgdmFyIGZ1bGxzY3JlZW49ZmFsc2U7XG4gICAgaWYocGFyYW1zLmZ1bGxzY3JlZW4pXG4gICAgICAgIHBhcmFtcy5mdWxsc2NyZWVuPShwYXJhbXMuZnVsbHNjcmVlbj09XCJ0cnVlXCIpO1xuXG4gICAgJChcIiNsb2FkaW5nSW5kaWNhdG9yXCIpLnNob3coKTtcblxuICAgIC8vIExvYWQgZGF0YVxuICAgIEJyYWluQm94LmluaXRCcmFpbkJveCgpXG4gICAgLnRoZW4oZnVuY3Rpb24gKCkgeyBjb25zb2xlLmxvZyhcIkJyYWluQm94IGluaXRpYWxpc2VkXCIpOyByZXR1cm4gQnJhaW5Cb3gubG9hZExhYmVsc2V0cygpOyB9KVxuICAgIC50aGVuKGZ1bmN0aW9uICgpIHsgY29uc29sZS5sb2coXCJMYWJlbCBzZXRzIGxvYWRlZFwiKTsgcmV0dXJuIEJyYWluQm94LmNvbmZpZ3VyZUJyYWluQm94KHBhcmFtcyk7IH0pXG4gICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIkJyYWluQm94IGNvbmZpZ3VyZWRcIik7XG4gICAgICAgIC8vIGJhY2t1cCB0aGUgb3JpZ2luYWwgTVJJIGluZm9cbiAgICAgICAgbXJpSW5mb09yaWcgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KEJyYWluQm94LmluZm8pKTtcbiAgICAgICAgIFxuICAgICAgICAvLyBTZXJpYWxpc2UgdGV4dCBhbm5vdGF0aW9ucyBvYmplY3QgKHRleHQgYW5ub3RhdGlvbnMgYXJlIHN0b3JlZCBhcyBvYmplY3RzIGluIHRoZVxuICAgICAgICAvLyBkYXRhYmFzZSwgYnV0IHVzZWQgYXMgYW4gYXJyYXkgaGVyZSlcbiAgICAgICAgaWYobXJpSW5mby5tcmkgJiYgbXJpSW5mby5tcmkuYW5ub3RhdGlvbnMpIHtcbiAgICAgICAgICAgIHRleHRBbm5vdGF0aW9uc0FycmF5ID0gQnJhaW5Cb3guYW5ub3RhdGlvbnNPYmplY3RUb0FycmF5KG1yaUluZm8ubXJpLmFubm90YXRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgLy8gQmluZCBnZW5lcmFsIGluZm9ybWF0aW9uXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICBiaW5kMihpbmZvX3Byb3h5LEJyYWluQm94LmluZm8sXCJuYW1lXCIsJChcIiNuYW1lXCIpKTtcbiAgICAgICAgYmluZDEoaW5mb19wcm94eSxCcmFpbkJveC5pbmZvLFwic291cmNlXCIsJChcIiNzb3VyY2VcIikpO1xuICAgICAgICBiaW5kMShpbmZvX3Byb3h5LEJyYWluQm94LmluZm8sXCJpbmNsdWRlZFwiLCQoXCIjaW5jbHVkZWRcIiksZGF0ZV9mb3JtYXQpO1xuXG5cbiAgICAvLyBCaW5kIHZvbHVtZS10eXBlIGFubm90YXRpb25zXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgdm9sQW5uUGFyYW0gPSB7XG4gICAgICAgICAgICB0YWJsZTogJChcInRhYmxlI2Fubm90YXRpb25zXCIpLFxuICAgICAgICAgICAgaW5mb19wcm94eTogaW5mb19wcm94eSxcbiAgICAgICAgICAgIGluZm86IEJyYWluQm94LmluZm8sXG4gICAgICAgICAgICB0clRlbXBsYXRlOiAkLm1hcChbXG4gICAgICAgICAgICAgICAgXCI8dHI+XCIsXG4gICAgICAgICAgICAgICAgXCIgPHRkIGNvbnRlbnRFZGl0YWJsZT10cnVlIGNsYXNzPSdub0VtcHR5Jz48L3RkPlwiLCAvLyBuYW1lXG4gICAgICAgICAgICAgICAgXCIgPHRkPjxzZWxlY3Q+XCIsJC5tYXAoQnJhaW5Cb3gubGFiZWxTZXRzLGZ1bmN0aW9uKG8pe3JldHVybiBcIjxvcHRpb24+XCIrby5uYW1lK1wiPC9vcHRpb24+XCJ9KSxcIjwvc2VsZWN0PjwvdGQ+XCIsXHQvLyB2YWx1ZVxuICAgICAgICAgICAgICAgIFwiIDx0ZCBjbGFzcz0nbm9FbXB0eSc+PC90ZD5cIiwgLy8gcHJvamVjdFxuICAgICAgICAgICAgICAgIFwiIDx0ZD48L3RkPlwiLCAvLyBtb2RpZmllZFxuICAgICAgICAgICAgICAgIFwiIDx0ZD5cIiwgLy8gYWNjZXNzXG4gICAgICAgICAgICAgICAgXCIgIDxkaXYgY2xhc3M9J2FjY2Vzcyc+XCIsXG4gICAgICAgICAgICAgICAgXCIgICA8c3BhbiBjbGFzcz0ndmlldycgdGl0bGU9J3ZpZXcgYW5ub3RhdGlvbnMnPjwvc3Bhbj5cIixcbiAgICAgICAgICAgICAgICBcIiAgIDxzcGFuIGNsYXNzPSdlZGl0JyB0aXRsZT0nZWRpdCBhbm5vdGF0aW9ucyc+PC9zcGFuPlwiLFxuICAgICAgICAgICAgICAgIFwiICAgPHNwYW4gY2xhc3M9J2FkZCcgdGl0bGU9J2FkZCBhbm5vdGF0aW9ucyc+PC9zcGFuPlwiLFxuICAgICAgICAgICAgICAgIFwiICAgPHNwYW4gY2xhc3M9J3JlbW92ZScgdGl0bGU9J3JlbW92ZSBhbm5vdGF0aW9ucyc+PC9zcGFuPlwiLFxuICAgICAgICAgICAgICAgIFwiICA8L2Rpdj5cIixcbiAgICAgICAgICAgICAgICBcIiA8L3RkPlwiLFxuICAgICAgICAgICAgICAgIFwiPC90cj5cIl0sZnVuY3Rpb24obyl7cmV0dXJuIG99KS5qb2luKFwiXCIpLFxuICAgICAgICAgICAgb2JqVGVtcGxhdGU6IFtcbiAgICAgICAgICAgICAgICB7ICAgdHlwZU9mQmluZGluZzoyLFxuICAgICAgICAgICAgICAgICAgICBwYXRoOlwibXJpLmF0bGFzLiMubmFtZVwiIC8vIG5hbWVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHsgICB0eXBlT2ZCaW5kaW5nOjIsXG4gICAgICAgICAgICAgICAgICAgIHBhdGg6XCJtcmkuYXRsYXMuIy5sYWJlbHNcIiwgLy92YWx1ZVxuICAgICAgICAgICAgICAgICAgICBmb3JtYXQ6IGZ1bmN0aW9uKGUsZCl7JChlKS5maW5kKFwic2VsZWN0XCIpLnByb3AoJ3NlbGVjdGVkSW5kZXgnLCQubWFwKEJyYWluQm94LmxhYmVsU2V0cyxmdW5jdGlvbihvKXtyZXR1cm4gby5zb3VyY2V9KS5pbmRleE9mKGQpKX0sXG4gICAgICAgICAgICAgICAgICAgIHBhcnNlOiBmdW5jdGlvbihlKXt2YXIgbmFtZT0kKGUpLmZpbmQoXCJzZWxlY3RcIikudmFsKCksaT0kLm1hcChCcmFpbkJveC5sYWJlbFNldHMsZnVuY3Rpb24obyl7cmV0dXJuIG8ubmFtZX0pLmluZGV4T2YobmFtZSk7cmV0dXJuIEJyYWluQm94LmxhYmVsU2V0c1tpXS5zb3VyY2V9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB7ICAgdHlwZU9mQmluZGluZzoxLCAvLyBwcm9qZWN0XG4gICAgICAgICAgICAgICAgICAgIHBhdGg6XCJtcmkuYXRsYXMuIy5wcm9qZWN0XCIsXG4gICAgICAgICAgICAgICAgICAgIGZvcm1hdDogZnVuY3Rpb24oZSxkKXskKGUpLmh0bWwoJzxhIGhyZWY9XCIvcHJvamVjdC8nK2QrJ1wiPicrZCsnPC9hPicpfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgeyAgIHR5cGVPZkJpbmRpbmc6MSxcbiAgICAgICAgICAgICAgICAgICAgcGF0aDpcIm1yaS5hdGxhcy4jLm1vZGlmaWVkXCIsXG4gICAgICAgICAgICAgICAgICAgIGZvcm1hdDogZGF0ZV9mb3JtYXRcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHsgICB0eXBlT2ZCaW5kaW5nOjEsXG4gICAgICAgICAgICAgICAgICAgIHBhdGg6XCJtcmkuYXRsYXMuIy5hY2Nlc3NcIixcbiAgICAgICAgICAgICAgICAgICAgZm9ybWF0OiBmdW5jdGlvbihlLGQpeyQoZSkuZmluZChcIi5hY2Nlc3NcIikuYXR0cignZGF0YS1sZXZlbCcsW1wibm9uZVwiLFwidmlld1wiLFwiZWRpdFwiLFwiYWRkXCIsXCJyZW1vdmVcIl0uaW5kZXhPZihkKSl9LFxuICAgICAgICAgICAgICAgICAgICBwYXJzZTogZnVuY3Rpb24oZSl7dmFyIGxldmVsPSQoZSkuZmluZChcIi5hY2Nlc3NcIikuYXR0cihcImRhdGEtbGV2ZWxcIik7cmV0dXJuIFtcIm5vbmVcIixcInZpZXdcIixcImVkaXRcIixcImFkZFwiLFwicmVtb3ZlXCJdW2xldmVsXX1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdXG4gICAgICAgIH07XG4gICAgICAgIGZvcih2YXIgaT0wO2k8QnJhaW5Cb3guaW5mby5tcmkuYXRsYXMubGVuZ3RoO2krKykge1xuICAgICAgICAgICAgQnJhaW5Cb3guYXBwZW5kQW5ub3RhdGlvblRhYmxlUm93KGksdm9sQW5uUGFyYW0pO1xuICAgICAgICB9XG4gICAgICAgIC8vIGNvbm5lY3QgcG9wLWRvd24gbWVudXNcbiAgICAgICAgJChkb2N1bWVudCkub24oJ2NoYW5nZScsIFwidGFibGUjYW5ub3RhdGlvbnMgc2VsZWN0XCIsIGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB2YXIgY29sPSQoXCJ0YWJsZSNhbm5vdGF0aW9ucyB0cjplcSgwKSB0aDplcShcIiskKHRoaXMpLmNsb3Nlc3QoJ3RkJylbMF0uY2VsbEluZGV4K1wiKVwiKS50ZXh0KCk7XG4gICAgICAgICAgICB2YXIgaW5kZXg9JCh0aGlzKS5jbG9zZXN0KCd0cicpWzBdLnJvd0luZGV4LTE7XG4gICAgICAgICAgICBzd2l0Y2goY29sKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBcIlZhbHVlXCI6XG4gICAgICAgICAgICAgICAgICAgIHZhciB1cmw9XCIvbGFiZWxzL1wiICsgaW5mb19wcm94eVtcIm1yaS5hdGxhcy5cIitpbmRleCtcIi5sYWJlbHNcIl07XG4gICAgICAgICAgICAgICAgICAgICQuZ2V0SlNPTih1cmwsZnVuY3Rpb24oanNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgQXRsYXNNYWtlcldpZGdldC5jb25maWd1cmVPbnRvbG9neShqc29uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIEF0bGFzTWFrZXJXaWRnZXQuY2hhbmdlUGVuQ29sb3IoMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBBdGxhc01ha2VyV2lkZ2V0LmJyYWluX2ltZy5pbWc9bnVsbDsgLy8gdG8gZm9yY2UgcmVkcmF3IHdpdGggbmV3IGNvbG9yc1xuICAgICAgICAgICAgICAgICAgICAgICAgQXRsYXNNYWtlcldpZGdldC5kcmF3SW1hZ2VzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKFwiI2xvYWRpbmdJbmRpY2F0b3JcIikuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAvLyB2b2x1bWUgYW5ub3RhdGlvbiB0YWJsZTogc2VsZWN0IHJvd1xuICAgICAgICAkKGRvY3VtZW50KS5vbignY2xpY2sgdG91Y2hzdGFydCcsIFwiI2Fubm90YXRpb25zIHRyXCIsZnVuY3Rpb24oKXtCcmFpbkJveC5zZWxlY3RBbm5vdGF0aW9uVGFibGVSb3coJCh0aGlzKS5pbmRleCgpLHZvbEFublBhcmFtKX0pO1xuICAgICAgICAvLyB2b2x1bWUgYW5ub3RhdGlvbnMgdGFibGU6IGFkZCwgcmVtb3ZlIGFuZCBzYXZlIGFubm90YXRpb25zXG4gICAgICAgICQoZG9jdW1lbnQpLm9uKCdjbGljayB0b3VjaHN0YXJ0JywgXCIjYWRkQW5ub3RhdGlvblwiLCBmdW5jdGlvbigpe2FkZEFubm90YXRpb24odm9sQW5uUGFyYW0pfSk7XG4gICAgICAgICQoZG9jdW1lbnQpLm9uKCdjbGljayB0b3VjaHN0YXJ0JywgXCIjcmVtb3ZlQW5ub3RhdGlvblwiLCBmdW5jdGlvbigpe3JlbW92ZUFubm90YXRpb24odm9sQW5uUGFyYW0pfSk7XG4gICAgICAgIC8vIHZvbHVtZSBhbm5vdGF0aW9ucyB0YWJsZTogc2VsZWN0IHRoZSBmaXJzdCByb3cgYnkgZGVmYXVsdFxuICAgICAgICAkKFwidGFibGUjYW5ub3RhdGlvbnMgdHJcIikucmVtb3ZlQ2xhc3MoXCJzZWxlY3RlZFwiKTtcbiAgICAgICAgJChcInRhYmxlI2Fubm90YXRpb25zIHRyXCIpLmVxKDEpLmFkZENsYXNzKFwic2VsZWN0ZWRcIik7XG5cbiAgICAvLyBCaW5kIHRleHQgYW5ub3RhdGlvbnNcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgIHZhciB0clRlbXBsYXRlO1xuICAgICAgICB2YXIgb2JqVGVtcGxhdGU7XG4gICAgICAgIHZhciBpLCBqLCBwLCBuO1xuXG4gICAgICAgIHRyVGVtcGxhdGUgPSBbXG4gICAgICAgICAgICBcIjx0cj5cIixcbiAgICAgICAgICAgIFwiIDx0ZCBjb250ZW50RWRpdGFibGU9dHJ1ZSBjbGFzcz0nbm9FbXB0eSc+PC90ZD5cIiwgLy8gbmFtZVxuICAgICAgICAgICAgXCIgPHRkIGNvbnRlbnRFZGl0YWJsZT10cnVlIGNsYXNzPSdub0VtcHR5Jz48L3RkPlwiLCAvLyB2YWx1ZVxuICAgICAgICAgICAgXCIgPHRkIGNsYXNzPSdub0VtcHR5Jz48L3RkPlwiLCAvLyBwcm9qZWN0XG4gICAgICAgICAgICBcIiA8dGQ+PC90ZD5cIiwgLy8gbW9kaWZpZWRcbiAgICAgICAgICAgIFwiIDx0ZD5cIiwgLy8gYWNjZXNzXG4gICAgICAgICAgICBcIiAgPGRpdiBjbGFzcz0nYWNjZXNzJz5cIixcbiAgICAgICAgICAgIFwiICAgPHNwYW4gY2xhc3M9J3ZpZXcnIHRpdGxlPSd2aWV3IGFubm90YXRpb25zJz48L3NwYW4+XCIsXG4gICAgICAgICAgICBcIiAgIDxzcGFuIGNsYXNzPSdlZGl0JyB0aXRsZT0nZWRpdCBhbm5vdGF0aW9ucyc+PC9zcGFuPlwiLFxuICAgICAgICAgICAgXCIgICA8c3BhbiBjbGFzcz0nYWRkJyB0aXRsZT0nYWRkIGFubm90YXRpb25zJz48L3NwYW4+XCIsXG4gICAgICAgICAgICBcIiAgIDxzcGFuIGNsYXNzPSdyZW1vdmUnIHRpdGxlPSdyZW1vdmUgYW5ub3RhdGlvbnMnPjwvc3Bhbj5cIixcbiAgICAgICAgICAgIFwiICA8L2Rpdj5cIixcbiAgICAgICAgICAgIFwiIDwvdGQ+XCIsXG4gICAgICAgICAgICBcIjwvdHI+XCJcbiAgICAgICAgXS5qb2luKFwiXCIpO1xuXG4gICAgICAgIG9ialRlbXBsYXRlID0gW1xuICAgICAgICAgICAgeyAgIHR5cGVPZkJpbmRpbmc6MixcbiAgICAgICAgICAgICAgICBwYXRoOlwiIy5uYW1lXCIsIC8vIG5hbWVcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7ICAgdHlwZU9mQmluZGluZzoyLFxuICAgICAgICAgICAgICAgIHBhdGg6XCIjLmRhdGFcIiAvLyB2YWx1ZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHsgICB0eXBlT2ZCaW5kaW5nOjEsXG4gICAgICAgICAgICAgICAgcGF0aDpcIiMucHJvamVjdFwiLCAvLyBwcm9qZWN0XG4gICAgICAgICAgICAgICAgZm9ybWF0OiBmdW5jdGlvbihlLGQpeyQoZSkuaHRtbCgnPGEgaHJlZj1cIi9wcm9qZWN0LycrZCsnXCI+JytkKyc8L2E+Jyl9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgeyAgIHR5cGVPZkJpbmRpbmc6MSxcbiAgICAgICAgICAgICAgICBwYXRoOlwiIy5tb2RpZmllZFwiLCAvLyBtb2RpZmllZFxuICAgICAgICAgICAgICAgIGZvcm1hdDogZGF0ZV9mb3JtYXRcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7ICAgdHlwZU9mQmluZGluZzoxLFxuICAgICAgICAgICAgICAgIHBhdGg6XCIjLmFjY2Vzc1wiLFxuICAgICAgICAgICAgICAgIGZvcm1hdDogZnVuY3Rpb24oZSxkKXskKGUpLmZpbmQoXCIuYWNjZXNzXCIpLmF0dHIoJ2RhdGEtbGV2ZWwnLEJyYWluQm94LmFjY2Vzc0xldmVscy5pbmRleE9mKGQpKX0sXG4gICAgICAgICAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKGUpe3ZhciBsZXZlbD0kKGUpLmZpbmQoXCIuYWNjZXNzXCIpLmF0dHIoXCJkYXRhLWxldmVsXCIpO3JldHVybiBCcmFpbkJveC5hY2Nlc3NMZXZlbHNbbGV2ZWxdfVxuICAgICAgICAgICAgfVxuICAgICAgICBdO1xuXG4gICAgICAgIHRleHRBbm5QYXJhbSA9IHtcbiAgICAgICAgICAgIHRhYmxlOiAkKFwidGFibGUjdGV4dEFubm90YXRpb25zXCIpLFxuICAgICAgICAgICAgaW5mb19wcm94eTogaW5mb19wcm94eSxcbiAgICAgICAgICAgIGluZm86IHRleHRBbm5vdGF0aW9uc0FycmF5LFxuICAgICAgICAgICAgdHJUZW1wbGF0ZTogdHJUZW1wbGF0ZSxcbiAgICAgICAgICAgIG9ialRlbXBsYXRlOiBvYmpUZW1wbGF0ZVxuICAgICAgICB9O1xuXG4gICAgICAgIGZvcihpPTA7aTx0ZXh0QW5ub3RhdGlvbnNBcnJheS5sZW5ndGg7aSsrKSB7XG4gICAgICAgICAgICBCcmFpbkJveC5hcHBlbmRBbm5vdGF0aW9uVGFibGVSb3coaSx0ZXh0QW5uUGFyYW0pO1xuICAgICAgICB9XG5cbiAgICAgICAgJChkb2N1bWVudCkub24oJ2NsaWNrIHRvdWNoc3RhcnQnLCBcIiN0ZXh0QW5ub3RhdGlvbnMgdHJcIixmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciB0YWJsZT0kKHRoaXMpLmNsb3Nlc3QoXCJ0Ym9keVwiKTtcbiAgICAgICAgICAgICQodGFibGUpLmZpbmQoXCJ0clwiKS5yZW1vdmVDbGFzcyhcInNlbGVjdGVkXCIpO1xuICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcyhcInNlbGVjdGVkXCIpO1xuICAgICAgICB9KTtcbiAgICAgICAgJChkb2N1bWVudCkub24oJ2NsaWNrIHRvdWNoc3RhcnQnLCBcIiNhZGRUZXh0QW5ub3RhdGlvblwiLCBmdW5jdGlvbigpe2FkZFRleHRBbm5vdGF0aW9uKHRleHRBbm5QYXJhbSl9KTtcbiAgICAgICAgJChkb2N1bWVudCkub24oJ2NsaWNrIHRvdWNoc3RhcnQnLCBcIiNyZW1vdmVUZXh0QW5ub3RhdGlvblwiLCBmdW5jdGlvbigpe3JlbW92ZVRleHRBbm5vdGF0aW9uKHRleHRBbm5QYXJhbSl9KTtcblxuICAgICAgICAvLyB0ZXh0IGFubm90YXRpb25zIHRhYmxlOiBzZWxlY3QgdGhlIGZpcnN0IHJvdyBieSBkZWZhdWx0XG4gICAgICAgICQoXCJ0YWJsZSN0ZXh0QW5ub3RhdGlvbnMgdHJcIikucmVtb3ZlQ2xhc3MoXCJzZWxlY3RlZFwiKTtcbiAgICAgICAgJChcInRhYmxlI3RleHRBbm5vdGF0aW9ucyB0clwiKS5lcSgxKS5hZGRDbGFzcyhcInNlbGVjdGVkXCIpO1xuICAgICAgICBcbiAgICAgICAgLy8gY29ubmVjdCBjbG9zZSBidXR0b24gaW4gbGFiZWxzIHNldFxuICAgICAgICAkKGRvY3VtZW50KS5vbignY2xpY2sgdG91Y2hzdGFydCcsIFwiI2xhYmVscy1jbG9zZVwiLCBmdW5jdGlvbigpeyQoXCIjbGFiZWxzZXRcIikuaGlkZSgpfSk7XG5cbiAgICAgICAgJChcIiNkYXRhXCIpLnNob3coKTtcblxuICAgIC8vIExpc3RlbiB0byBjaGFuZ2VzIHRoYXQgdHJpZ2dlciBhIG1ldGFkYXRhIHNhdmVcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICAvLyBzZW5kIGRhdGEgd2hlbiBmb2N1cyBpcyBsb3N0IChvbiBibHVyKVxuICAgICAgICAkKGRvY3VtZW50KS5vbignYmx1cicsIFwiW2NvbnRlbnRlZGl0YWJsZV1cIiwgZnVuY3Rpb24gZnJvbV9wcm9qZWN0KGUpIHtcbiAgICAgICAgICAgIHNhdmVBbm5vdGF0aW9uc0NoYW5nZShCcmFpbkJveC5pbmZvKTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIGJsdXIgd2hlbiBbZW50ZXJdIGlzIGNsaWNrZWQsIHRvIHRyaWdnZXIgZGF0YSBzZW5kaW5nXG4gICAgICAgICQoZG9jdW1lbnQpLm9uKCdrZXlkb3duJywgXCJbY29udGVudGVkaXRhYmxlXVwiLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBpZihlLndoaWNoPT0xMyAmJiAkKGUudGFyZ2V0KS5hdHRyKCdjb250ZW50ZWRpdGFibGUnKSkge1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAkKGUudGFyZ2V0KS5ibHVyKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBibHVyIHdoZW4gPHNlbGVjdD4gY2hhbmdlcyB2YWx1ZSB0byB0cmlnZ2VyIGRhdGEgc2VuZGluZ1xuICAgICAgICAkKFwiI2Fubm90YXRpb25zIHRib2R5LCAjdGV4dEFubm90YXRpb25zIHRib2R5XCIpLm9uKCdjaGFuZ2UnLCBcInNlbGVjdFwiLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICAkKGUudGFyZ2V0KS5ibHVyKCk7XG4gICAgICAgICAgICBzYXZlQW5ub3RhdGlvbnNDaGFuZ2UoQnJhaW5Cb3guaW5mbyk7XG4gICAgICAgIH0pO1xuXG4gICAgLy8gV1MgQXV0b2NvbXBsZXRpb25cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgdmFyIGNiLCBsYWJlbDtcbiAgICAgICAgQXRsYXNNYWtlcldpZGdldC5yZWNlaXZlRnVuY3Rpb25zW1wic2ltaWxhclByb2plY3ROYW1lc1F1ZXJ5XCJdID0gZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgdmFyIGFyciA9IFtdO1xuICAgICAgICAgICAgaWYobGFiZWw9PVwic2ltaWxhclByb2plY3ROYW1lc1wiKVxuICAgICAgICAgICAgICAgIGFycj0kLm1hcChkYXRhLm1ldGFkYXRhLGZ1bmN0aW9uKG8pe3JldHVybiB7bGFiZWw6by5zaG9ydG5hbWUsc2hvcnRuYW1lOm8uc2hvcnRuYW1lLG5hbWU6by5uYW1lfX0pO1xuICAgICAgICAgICAgY2IoYXJyKTtcbiAgICAgICAgfTtcblxuICAgICAgICAkKFwiLmF1dG9jb21wbGV0ZVwiKS5hdXRvY29tcGxldGUoe1xuICAgICAgICAgICAgbWluTGVuZ3RoOiAwLFxuICAgICAgICAgICAgc291cmNlOiBmdW5jdGlvbihyZXEscmVzKSB7XG4gICAgICAgICAgICAgICAgdmFyIGtleSA9ICQodGhpcy5lbGVtZW50KS5hdHRyKCdkYXRhLWF1dG9jb21wbGV0ZScpO1xuICAgICAgICAgICAgICAgIHN3aXRjaChrZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBcInVzZXIuc2ltaWxhclByb2plY3ROYW1lc1wiOlxuICAgICAgICAgICAgICAgICAgICAgICAgQXRsYXNNYWtlcldpZGdldC5zb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeSh7XCJ0eXBlXCI6XCJzaW1pbGFyUHJvamVjdE5hbWVzUXVlcnlcIiwgXCJtZXRhZGF0YVwiOntcInByb2plY3ROYW1lXCI6cmVxLnRlcm19fSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw9XCJzaW1pbGFyUHJvamVjdE5hbWVzXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2I9cmVzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNlbGVjdDpmdW5jdGlvbihlLHVpKSB7XG4gICAgICAgICAgICAgICAgdmFyIGlyb3c9JChlLnRhcmdldCkuY2xvc2VzdCgndHInKS5pbmRleCgpO1xuICAgICAgICAgICAgICAgIGluZm9fcHJveHlbXCJtcmkuYXRsYXMuXCIraXJvdytcIi5wcm9qZWN0XCJdPXVpLml0ZW0ubmFtZTtcblxuICAgICAgICAgICAgICAgIC8vIGFkZCB1c2VyIHRvIGFjY2VzcyBvYmplY3RzXG4gICAgICAgICAgICAgICAgLy8gcHJvamVjdEluZm8uY29sbGFib3JhdG9ycy5saXN0W2lyb3ddLnVzZXJJRD11aS5pdGVtLm5pY2tuYW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgIH0pXG4gICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICQoXCIjbXNnTG9nXCIpLmh0bWwoXCJFUlJPUjogQ2FuJ3QgbG9hZCBkYXRhLiBcIiArIGVycik7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICB9KTtcbn1cblxuJChcIiNhZGRQcm9qZWN0XCIpLmNsaWNrKGZ1bmN0aW9uKCl7bG9jYXRpb249XCIvcHJvamVjdC9uZXdcIn0pO1xuXG4vKipcbiAqIEBmdW5jdGlvbiBhZGRBbm5vdGF0aW9uXG4gKiBAZGVzYyBBZGQgYW4gZW1wdHkgdm9sdW1lIGFubm90YXRpb25cbiAqL1xuZnVuY3Rpb24gYWRkQW5ub3RhdGlvbihwYXJhbSkge1xuICAgIHZhciBkYXRlPW5ldyBEYXRlKCk7XG4gICAgdmFyIGksIGZvdW5kO1xuXG4gICAgLy8gY2hlY2sgdGhhdCB0aGVyZSBpcyBubyBvdGhlciBlbXB0eSBhbm5vdGF0aW9uIGFscmVhZHkgY3JlYXRlZFxuICAgIGZvdW5kID0gZmFsc2U7XG4gICAgZm9yKGk9MDtpPEJyYWluQm94LmluZm8ubXJpLmF0bGFzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgaWYoQnJhaW5Cb3guaW5mby5tcmkuYXRsYXNbaV0ubmFtZSA9PT0gXCJcIiAmJiBCcmFpbkJveC5pbmZvLm1yaS5hdGxhc1tpXS5wcm9qZWN0ID09PSBcIlwiKSB7XG4gICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZihmb3VuZCkge1xuICAgICAgICAkKFwiI2Fubm90YXRpb25NZXNzYWdlXCIpLnRleHQoXCJBbiBlbXB0eSBhbm5vdGF0aW9uIGFscmVhZHkgZXhpc3RzXCIpO1xuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7JChcIiNhbm5vdGF0aW9uTWVzc2FnZVwiKS50ZXh0KFwiXCIpfSwyMDAwKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBcbiAgICAvLyBhZGQgZGF0YSB0byBhbm5vdGF0aW9ucyBhcnJheVxuICAgIEJyYWluQm94LmluZm8ubXJpLmF0bGFzLnB1c2goe1xuICAgICAgICBuYW1lOlwiXCIsXG4gICAgICAgIHByb2plY3Q6XCJcIixcbiAgICAgICAgYWNjZXNzOiBcImVkaXRcIiwgXG4gICAgICAgIGNyZWF0ZWQ6IGRhdGUudG9KU09OKCksIFxuICAgICAgICBtb2RpZmllZDogZGF0ZS50b0pTT04oKSwgXG4gICAgICAgIGZpbGVuYW1lOiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKStcIi5uaWkuZ3pcIixcdC8vIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGZpbGVuYW1lXG4gICAgICAgIGxhYmVsczogXCJmb3JlZ3JvdW5kLmpzb25cIixcbiAgICAgICAgb3duZXI6IEF0bGFzTWFrZXJXaWRnZXQuVXNlci51c2VybmFtZSxcbiAgICAgICAgdHlwZTogXCJ2b2x1bWVcIlxuICAgIH0pO1xuXG4gICAgLy8gYWRkIGFuZCBiaW5kIG5ldyB0YWJsZSByb3dcbiAgICB2YXIgaT1CcmFpbkJveC5pbmZvLm1yaS5hdGxhcy5sZW5ndGgtMTtcbiAgICBCcmFpbkJveC5hcHBlbmRBbm5vdGF0aW9uVGFibGVSb3coaSxwYXJhbSk7XG4gICAgXG4gICAgLy9zZWxlY3QgbmV3IGFubm90YXRpb25cbiAgICBCcmFpbkJveC5zZWxlY3RBbm5vdGF0aW9uVGFibGVSb3coaSxwYXJhbSk7XG5cbiAgICAvLyB1cGRhdGUgaW4gc2VydmVyXG4gICAgc2F2ZUFubm90YXRpb25zQ2hhbmdlKEJyYWluQm94LmluZm8pO1xufVxuXG4vKipcbiAqIEBmdW5jdGlvbiByZW1vdmVBbm5vdGF0aW9uXG4gKi9cbmZ1bmN0aW9uIHJlbW92ZUFubm90YXRpb24ocGFyYW0pIHtcbiAgICAvLyBmaW5kIHJvdyBpbmRleFxuICAgIHZhciBpbmRleD0kKHBhcmFtLnRhYmxlKS5maW5kKFwidGJvZHkgLnNlbGVjdGVkXCIpLmluZGV4KCk7XG5cbiAgICAvLyBwcmV2ZW50IHJlbW92YWwgb2YgYSBsYXN0IHByb2pldC1sZXNzIGFubm90YXRpb25cbiAgICBpZihCcmFpbkJveC5pbmZvLm1yaS5hdGxhc1tpbmRleF0ucHJvamVjdCA9PSBcIlwiKSB7XG4gICAgICAgIHZhciBuUHVibGljQW5ub3RhdGlvbnMgPSBCcmFpbkJveC5pbmZvLm1yaS5hdGxhcy5tYXAoZnVuY3Rpb24obyl7cmV0dXJuIChvLnByb2plY3Q9PVwiXCIpfSkubGVuZ3RoO1xuICAgICAgICBpZihuUHVibGljQW5ub3RhdGlvbnMgPT0gMSkge1xuICAgICAgICAgICAgJChcIiNhbm5vdGF0aW9uTWVzc2FnZVwiKS50ZXh0KFwiVGhlcmUgaGFzIHRvIGJlIGF0IGxlYXN0IDEgcHVibGljIHZvbHVtZSBhbm5vdGF0aW9uXCIpO1xuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpeyQoXCIjYW5ub3RhdGlvbk1lc3NhZ2VcIikudGV4dChcIlwiKX0sMjAwMCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyByZW1vdmUgcm93IGZyb20gdGFibGVcbiAgICAkKHBhcmFtLnRhYmxlKS5maW5kKCd0Ym9keSB0cjplcSgnK2luZGV4KycpJykucmVtb3ZlKCk7XG5cbiAgICAvLyBzZWxlY3QgcHJldmlvdXMgcm93IChvciAxc3Qgb25lKVxuICAgIEJyYWluQm94LnNlbGVjdEFubm90YXRpb25UYWJsZVJvdyhNYXRoLm1heCgwLGluZGV4LTEpLHBhcmFtKTtcblxuICAgIC8vIHJlbW92ZSBiaW5kaW5nXG4gICAgSlNPTi5zdHJpbmdpZnkocGFyYW0uaW5mb19wcm94eSk7IC8vIHVwZGF0ZSBCcmFpbkJveC5pbmZvIGZyb20gaW5mb19wcm94eVxuICAgIHZhciBpcm93PUJyYWluQm94LmluZm8ubXJpLmF0bGFzLmxlbmd0aC0xO1xuICAgIGZvcih2YXIgaWNvbD0wOyBpY29sPHBhcmFtLm9ialRlbXBsYXRlLmxlbmd0aDsgaWNvbCsrKSB7XG4gICAgICAgIHVuYmluZDIocGFyYW0uaW5mb19wcm94eSxwYXJhbS5vYmpUZW1wbGF0ZVtpY29sXS5wYXRoLnJlcGxhY2UoXCIjXCIsIGlyb3cpKTtcbiAgICB9XG5cbiAgICAvLyByZW1vdmUgcm93IGZyb20gQnJhaW5Cb3guaW5mby5tcmkuYXRsYXNcbiAgICBCcmFpbkJveC5pbmZvLm1yaS5hdGxhcy5zcGxpY2UoaW5kZXgsMSk7XG5cbiAgICAvLyB1cGRhdGUgaW4gc2VydmVyXG4gICAgc2F2ZUFubm90YXRpb25zQ2hhbmdlKEJyYWluQm94LmluZm8pO1xufVxuLyoqXG4gKiBAZnVuY3Rpb24gYWRkVGV4dEFubm90YXRpb25cbiAqL1xuZnVuY3Rpb24gYWRkVGV4dEFubm90YXRpb24ocGFyYW0pIHtcbiAgICB2YXIgZGF0ZT1uZXcgRGF0ZSgpO1xuICAgIHZhciBpO1xuICAgIFxuICAgIC8vIGNoZWNrIHRoYXQgdGhlcmUgaXMgbm8gb3RoZXIgZW1wdHkgYW5ub3RhdGlvbiBhbHJlYWR5IGNyZWF0ZWRcbiAgICBpZihCcmFpbkJveC5pbmZvLm1yaS5hbm5vdGF0aW9uc1tcIlwiXSAmJiBCcmFpbkJveC5pbmZvLm1yaS5hbm5vdGF0aW9uc1tcIlwiXVtcIlwiXSkge1xuICAgICAgICAkKFwiI3RleHRBbm5vdGF0aW9uTWVzc2FnZVwiKS50ZXh0KFwiQW4gZW1wdHkgYW5ub3RhdGlvbiBhbHJlYWR5IGV4aXN0c1wiKTtcbiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpeyQoXCIjdGV4dEFubm90YXRpb25NZXNzYWdlXCIpLnRleHQoXCJcIil9LDIwMDApO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gYWRkIGRhdGEgdG8gYW5ub3RhdGlvbnMgYXJyYXlcbiAgICB0ZXh0QW5ub3RhdGlvbnNBcnJheS5wdXNoKHtcbiAgICAgICAgbmFtZTpcIlwiLFxuICAgICAgICBwcm9qZWN0OlwiXCIsXG4gICAgICAgIGFjY2VzczogXCJlZGl0XCIsIFxuICAgICAgICBjcmVhdGVkOiBkYXRlLnRvSlNPTigpLCBcbiAgICAgICAgbW9kaWZpZWQ6IGRhdGUudG9KU09OKCksIFxuICAgICAgICBvd25lcjogQXRsYXNNYWtlcldpZGdldC5Vc2VyLnVzZXJuYW1lLFxuICAgICAgICB0eXBlOiBcInRleHRcIixcbiAgICAgICAgZGF0YTogXCJcIlxuICAgIH0pO1xuICAgIC8vIGFkZCBhbmQgYmluZCBuZXcgdGFibGUgcm93XG4gICAgdmFyIGk9dGV4dEFubm90YXRpb25zQXJyYXkubGVuZ3RoLTE7XG4gICAgQnJhaW5Cb3guYXBwZW5kQW5ub3RhdGlvblRhYmxlUm93KGkscGFyYW0pO1xuXG4gICAgLy9zZWxlY3QgbmV3IGFubm90YXRpb25cbiAgICBzZWxlY3RUZXh0QW5ub3RhdGlvblRhYmxlUm93KGkscGFyYW0pO1xuXG4gICAgLy8gc2F2ZSBjaGFuZ2VcbiAgICBzYXZlQW5ub3RhdGlvbnNDaGFuZ2UoQnJhaW5Cb3guaW5mbyk7XG59XG4vKipcbiAqIEBmdW5jdGlvbiByZW1vdmVUZXh0QW5ub3RhdGlvblxuICovXG5mdW5jdGlvbiByZW1vdmVUZXh0QW5ub3RhdGlvbihwYXJhbSkge1xuICAgIHZhciBpbmRleD0kKHBhcmFtLnRhYmxlKS5maW5kKFwidGJvZHkgLnNlbGVjdGVkXCIpLmluZGV4KCk7XG4gICAgJChwYXJhbS50YWJsZSkuZmluZCgndGJvZHkgdHI6ZXEoJytpbmRleCsnKScpLnJlbW92ZSgpO1xuICAgIC8vIHJlbW92ZSBiaW5kaW5nXG4gICAgSlNPTi5zdHJpbmdpZnkocGFyYW0uaW5mb19wcm94eSk7IC8vIHVwZGF0ZSB0ZXh0QW5ub3RhdGlvbnNBcnJheSBmcm9tIGluZm9fcHJveHlcbiAgICB2YXIgaXJvdz10ZXh0QW5ub3RhdGlvbnNBcnJheS5sZW5ndGgtMTtcbiAgICBmb3IodmFyIGljb2w9MDsgaWNvbDxwYXJhbS5vYmpUZW1wbGF0ZS5sZW5ndGg7IGljb2wrKykge1xuICAgICAgICB1bmJpbmQyKHBhcmFtLmluZm9fcHJveHkscGFyYW0ub2JqVGVtcGxhdGVbaWNvbF0ucGF0aC5yZXBsYWNlKFwiI1wiLCBpcm93KSk7XG4gICAgfVxuICAgIC8vIHJlbW92ZSByb3cgZnJvbSB0ZXh0QW5ub3RhdGlvbnNBcnJheVxuICAgIHRleHRBbm5vdGF0aW9uc0FycmF5LnNwbGljZShpbmRleCwxKTtcblxuICAgIC8vIHNlbGVjdCBwcmV2aW91cyByb3cgKG9yIDFzdCBvbmUpXG4gICAgc2VsZWN0VGV4dEFubm90YXRpb25UYWJsZVJvdyhNYXRoLm1heCgwLGluZGV4LTEpLHBhcmFtKTtcblxuICAgIC8vIHNhdmUgY2hhbmdlXG4gICAgc2F2ZUFubm90YXRpb25zQ2hhbmdlKEJyYWluQm94LmluZm8pO1xufVxuZnVuY3Rpb24gc2VsZWN0VGV4dEFubm90YXRpb25UYWJsZVJvdyhpbmRleCxwYXJhbSkge1xuICAgIHZhciB0YWJsZT1wYXJhbS50YWJsZTtcbiAgICB2YXIgY3VycmVudEluZGV4PSQodGFibGUpLmZpbmQoXCJ0ci5zZWxlY3RlZFwiKS5pbmRleCgpO1xuXG4gICAgaWYoaW5kZXg+PTAgJiYgY3VycmVudEluZGV4IT1pbmRleCkge1xuICAgICAgICAkKHRhYmxlKS5maW5kKFwidHJcIikucmVtb3ZlQ2xhc3MoXCJzZWxlY3RlZFwiKTtcbiAgICAgICAgJCh0YWJsZSkuZmluZCgndGJvZHkgdHI6ZXEoJytpbmRleCsnKScpLmFkZENsYXNzKFwic2VsZWN0ZWRcIik7XG4gICAgfVxufVxuXG4vKipcbiAqIEBmdW5jdGlvbiBzYXZlQW5ub3RhdGlvbnNDaGFuZ2VcbiAqL1xuZnVuY3Rpb24gc2F2ZUFubm90YXRpb25zQ2hhbmdlKGluZm8pIHtcbiAgICB2YXIgaSwgajtcblxuICAgIC8vIHVwZGF0ZSBjb250ZW50IG9mIHByb2plY3RJbmZvIG9iamVjdCBmcm9tIHByb3h5IGJ5IGNhbGxpbmcgYWxsIGdldHRlcnNcbiAgICBKU09OLnN0cmluZ2lmeShpbmZvX3Byb3h5KTtcblxuICAgIC8vIGNoZWNrIHRoZSBpbmZvIG9iamVjdCBmb3IgZHVwbGljYXRlIHZvbHVtZSBhbm5vdGF0aW9uc1xuICAgIGZvcihpPTA7aTxpbmZvLm1yaS5hdGxhcy5sZW5ndGgtMTtpKyspIHtcbiAgICAgICAgZm9yKGo9aSsxO2o8aW5mby5tcmkuYXRsYXMubGVuZ3RoO2orKykge1xuICAgICAgICAgICAgaWYoIGluZm8ubXJpLmF0bGFzW2ldLm5hbWUgPT09IGluZm8ubXJpLmF0bGFzW2pdLm5hbWVcbiAgICAgICAgICAgICAgICAmJiBpbmZvLm1yaS5hdGxhc1tpXS5wcm9qZWN0ID09PSBpbmZvLm1yaS5hdGxhc1tqXS5wcm9qZWN0KSB7XG4gICAgICAgICAgICAgICAgJChcIiNhbm5vdGF0aW9uTWVzc2FnZVwiKS50ZXh0KFwiVGhlcmUgaXMgYWxyZWFkeSBhbiBhbm5vdGF0aW9uIHdpdGggdGhhdCBuYW1lIGFuZCBwcm9qZWN0XCIpO1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXskKFwiI2Fubm90YXRpb25NZXNzYWdlXCIpLnRleHQoXCJcIil9LDIwMDApO1xuICAgICAgICAgICAgICAgIC8vJC5leHRlbmQodHJ1ZSwgaW5mby5tcmksIG1yaUluZm9PcmlnLm1yaSk7XG4gICAgICAgICAgICAgICAgcmVzZXRCaW5kaW5nUHJveHkodm9sQW5uUGFyYW0sIG1yaUluZm9PcmlnKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBjaGVjayB0aGUgaW5mbyBvYmplY3QgZm9yIGR1cGxpY2F0ZSB0ZXh0IGFubm90YXRpb25zXG4gICAgZm9yKGk9MDtpPHRleHRBbm5vdGF0aW9uc0FycmF5Lmxlbmd0aC0xO2krKykge1xuICAgICAgICBmb3Ioaj1pKzE7ajx0ZXh0QW5ub3RhdGlvbnNBcnJheS5sZW5ndGg7aisrKSB7XG4gICAgICAgICAgICBpZiggdGV4dEFubm90YXRpb25zQXJyYXlbaV0ubmFtZSA9PT0gdGV4dEFubm90YXRpb25zQXJyYXlbal0ubmFtZVxuICAgICAgICAgICAgICAgICYmIHRleHRBbm5vdGF0aW9uc0FycmF5W2ldLnByb2plY3QgPT09IHRleHRBbm5vdGF0aW9uc0FycmF5W2pdLnByb2plY3QpIHtcbiAgICAgICAgICAgICAgICAkKFwiI3RleHRBbm5vdGF0aW9uTWVzc2FnZVwiKS50ZXh0KFwiVGhlcmUgaXMgYWxyZWFkeSBhbiBhbm5vdGF0aW9uIHdpdGggdGhhdCBuYW1lIGFuZCBwcm9qZWN0XCIpO1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXskKFwiI3RleHRBbm5vdGF0aW9uTWVzc2FnZVwiKS50ZXh0KFwiXCIpfSwyMDAwKTtcbiAgICAgICAgICAgICAgICAvLyQuZXh0ZW5kKHRydWUsIHRleHRBbm5vdGF0aW9uc0FycmF5LCBCcmFpbkJveC5hbm5vdGF0aW9uc09iamVjdFRvQXJyYXkobXJpSW5mb09yaWcubXJpLmFubm90YXRpb25zKSk7XG4gICAgICAgICAgICAgICAgcmVzZXRCaW5kaW5nUHJveHkodGV4dEFublBhcmFtLCBCcmFpbkJveC5hbm5vdGF0aW9uc09iamVjdFRvQXJyYXkobXJpSW5mb09yaWcubXJpLmFubm90YXRpb25zKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgICAgICBcbiAgICAvLyBjb252ZXJ0IHRoZSB0ZXh0IGFubm90YXRpb25zIGFycmF5IGludG8gYW4gb2JqZWN0XG4gICAgaW5mby5tcmkuYW5ub3RhdGlvbnMgPSBCcmFpbkJveC5hbm5vdGF0aW9uc0FycmF5VG9PYmplY3QodGV4dEFubm90YXRpb25zQXJyYXkpO1xuICAgIFxuICAgIC8vIGNvbXB1dGUgYSBkaWZmIHBhdGNoIGJldHdlZW4gdGhlIG5ldyBhbmQgb2xkIHZlcnNpb25zIG9mIHRoZSBpbmZvIG9iamVjdFxuICAgIHZhciBwYXRjaCA9IGpzb25wYXRjaC5jb21wYXJlKG1yaUluZm9PcmlnLCBpbmZvKTtcbiAgICBpZihwYXRjaC5sZW5ndGggPT0gMCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIk5vdGhpbmcgY2hhbmdlZFwiKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBcbiAgICAvLyBzZW5kIHRoZSBwYXRjaCB0byB0aGUgc2VydmVyIGFuZCB1cGRhdGUgdGhlIHN0b3JlZCB2ZXJzaW9uXG4gICAgQXRsYXNNYWtlcldpZGdldC5zZW5kU2F2ZU1ldGFkYXRhTWVzc2FnZShpbmZvLFwicGF0Y2hcIixwYXRjaClcbiAgICAudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgbXJpSW5mb09yaWcgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGluZm8pKTtcbiAgICB9KTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///5\n')}]);